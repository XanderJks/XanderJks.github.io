require('dotenv').config();
const express = require('express');
const cors = require('cors');
const { OpenAI } = require('openai'); // Zorg dat je de nieuwste 'openai' package hebt geÃ¯nstalleerd

const app = express();
const port = process.env.PORT || 3000;

// BELANGRIJK: Zorg dat je je Assistent ID hier instelt.
// Je kunt dit ook via een omgevingsvariabele doen als je meerdere assistenten hebt.
const ASSISTANT_ID = process.env.OPENAI_ASSISTANT_ID; // Bijvoorbeeld: "asst_YOUR_ASSISTANT_ID_HERE"

if (!ASSISTANT_ID) {
  console.error("Fout: OPENAI_ASSISTANT_ID is niet ingesteld in de omgevingsvariabelen of code.");
  process.exit(1); // Stop de applicatie als de ID ontbreekt
}

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// Middleware
app.use(cors());
app.use(express.json());

// Opslag voor thread ID's (eenvoudig voorbeeld, in productie gebruik je een database)
// Dit slaat de thread ID's op per sessie/gebruiker (of in dit geval, per unieke 'sessieKey' uit de frontend)
const userThreads = {};

// API Endpoint om met de assistent te chatten
app.post('/api/chat', async (req, res) => {
  const { message, sessionKey } = req.body; // 'sessionKey' om threads te koppelen

  if (!message) {
    return res.status(400).json({ error: 'Bericht is vereist.' });
  }

  // Genereer of haal de thread ID op voor deze sessie
  let threadId = userThreads[sessionKey];

  try {
    // 1. Maak een nieuwe thread aan als deze nog niet bestaat voor de sessie
    if (!threadId) {
      const thread = await openai.beta.threads.create();
      threadId = thread.id;
      userThreads[sessionKey] = threadId; // Sla de nieuwe thread ID op
      console.log(`Nieuwe thread aangemaakt voor sessie ${sessionKey}: ${threadId}`);
    } else {
      console.log(`Bestaande thread gebruikt voor sessie ${sessionKey}: ${threadId}`);
    }

    // 2. Voeg het bericht van de gebruiker toe aan de thread
    await openai.beta.threads.messages.create(
      threadId,
      { role: "user", content: message }
    );

    // 3. Start de 'run' om de assistent het bericht te laten verwerken
    let run = await openai.beta.threads.runs.create(
      threadId,
      { assistant_id: ASSISTANT_ID }
    );

    // 4. Poll de status van de 'run' totdat deze 'completed' is
    while (run.status === "queued" || run.status === "in_progress") {
      await new Promise(resolve => setTimeout(resolve, 500)); // Wacht 0.5 seconde
      run = await openai.beta.threads.runs.retrieve(
        threadId,
        run.id
      );
      console.log(`Run status: ${run.status}`);
    }

    // 5. Haal de laatste berichten op uit de thread
    const messages = await openai.beta.threads.messages.list(
      threadId,
      { order: 'desc', limit: 1 } // Haal alleen het meest recente bericht op
    );

    // Filter de antwoorden van de assistent
    const assistantReply = messages.data.find(msg => msg.role === 'assistant');

    if (assistantReply && assistantReply.content && assistantReply.content.length > 0) {
      // Content van Assistants API is een array van TextContentBlock
      const textContent = assistantReply.content.find(content => content.type === 'text');
      if (textContent) {
        res.json({ reply: textContent.text.value, threadId: threadId });
      } else {
        res.status(500).json({ error: 'Geen tekstinhoud gevonden in het antwoord van de assistent.' });
      }
    } else {
      res.status(500).json({ error: 'Geen antwoord ontvangen van de assistent.' });
    }

  } catch (error) {
    console.error('Fout bij het communiceren met OpenAI Assistent API:', error);
    if (error.response) {
      console.error(error.response.status, error.response.data);
      res.status(error.response.status).json({ error: error.response.data.error.message || 'Fout van OpenAI API.' });
    } else {
      res.status(500).json({ error: 'Interne serverfout bij het verwerken van je verzoek.' });
    }
  }
});

// Start de server
app.listen(port, () => {
  console.log(`Backend server luistert op http://localhost:${port}`);
  console.log(`OpenAI API Key geladen: ${process.env.OPENAI_API_KEY ? 'Ja' : 'Nee'}`);
  console.log(`OpenAI Assistant ID: ${ASSISTANT_ID}`);
});